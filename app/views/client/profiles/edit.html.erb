<div class="container mx-auto px-6 py-8">
  <div>
    <div class="mb-8">
      <%= link_to client_profile_path, class: "text-blue-hero hover:underline inline-flex items-center mb-4" do %>
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Retour au profil
      <% end %>
      <h1 class="text-4xl font-bold text-gray-900 mb-2">Modifier mon profil</h1>
      <p class="text-gray-600">Mettez à jour vos informations personnelles</p>
    </div>

    <div class="bg-white rounded-super p-8 shadow-sm">
      <%= form_with url: client_profile_path, method: :patch, data: { turbo: false }, class: "space-y-6" do |f| %>
        
        <% if current_user&.errors&.any? %>
          <div class="bg-red-50 border-l-4 border-red-hero rounded-lg p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-hero" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-bold text-red-800">Erreurs détectées :</h3>
                <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                  <% current_user.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Anonymity Info -->
        <div class="bg-blue-50 border-l-4 border-blue-hero rounded-lg p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-hero" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-bold text-blue-800">Protection de votre anonymat</h3>
              <p class="text-sm text-blue-700 mt-1">
                Votre pseudonyme/initiales sera visible par les professionnels. Votre adresse complète ne sera révélée qu'après validation définitive d'une réservation.
              </p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <%= f.label :first_name, "Prénom", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.text_field :first_name, value: current_user&.first_name, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent" %>
          </div>
          <div>
            <%= f.label :last_name, "Nom", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.text_field :last_name, value: current_user&.last_name, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent" %>
          </div>
        </div>

        <!-- Display Complete Name Option -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <div class="flex items-start space-x-3">
            <div class="flex items-center h-5">
              <%= f.check_box :display_complete_name, checked: current_user&.display_complete_name?, class: "w-4 h-4 text-red-hero border-gray-300 rounded focus:ring-red-hero" %>
            </div>
            <div class="flex-1">
              <%= f.label :display_complete_name, "Afficher mon nom complet aux professionnels", class: "block text-sm font-medium text-gray-700 cursor-pointer" %>
              <p class="text-sm text-gray-600 mt-1">
                Si cette option est activée, les professionnels verront votre nom complet (<%= [current_user&.first_name, current_user&.last_name].compact.join(' ') || 'votre nom' %>). 
                Si elle est désactivée, ils verront uniquement vos initiales (<%= current_user&.pseudonym %>) pour protéger votre anonymat.
              </p>
            </div>
          </div>
        </div>

        <div>
          <%= f.label :email, "Email", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.email_field :email, value: current_user&.email, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent" %>
        </div>

        <div>
          <%= f.label :phone_number, "Téléphone", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.telephone_field :phone_number, value: current_user&.phone_number, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent" %>
        </div>

        <% if false %>
        <!-- Address Clarification -->
        <div class="bg-blue-50 border-l-4 border-blue-hero rounded-lg p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-hero" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-bold text-blue-800">À propos de vos adresses</h3>
              <p class="text-sm text-blue-700 mt-1">
                L'adresse de facturation ci-dessous est votre adresse d'inscription utilisée pour la facturation. Les lieux de service sont flexibles et définis individuellement. Les prestations doivent être effectuées dans un lieu privé résidentiel avec un espace approprié. 
                <%= link_to "En savoir plus", "#", class: "underline font-medium" %>
              </p>
            </div>
          </div>
        </div>

        <h3 class="text-lg font-bold text-gray-900 mt-6">Adresse de facturation</h3>
        <p class="text-sm text-gray-600 mb-4">Utilisée pour les factures et la correspondance administrative</p>

        <div>
          <%= f.label :billing_address, "Adresse", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.text_field :billing_address, value: @profile&.billing_address, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent", placeholder: "123 Rue de Example" %>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <%= f.label :billing_postal_code, "Code postal", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.text_field :billing_postal_code, value: @profile&.billing_postal_code, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent", placeholder: "75001" %>
          </div>
          <div>
            <%= f.label :billing_city, "Ville", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.text_field :billing_city, value: @profile&.billing_city, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent", placeholder: "Paris" %>
          </div>
        </div>

        <hr class="my-8 border-gray-200">
        <% end %>

        <h3 class="text-lg font-bold text-gray-900">Mes lieux de service enregistrés</h3>
        <p class="text-sm text-gray-600 mb-4">Gérez les adresses où vous souhaitez recevoir des services</p>

        <!-- Existing Service Locations -->
        <div class="space-y-4 mb-4">
          <% (@profile&.service_locations || []).each_with_index do |location, index| %>
            <% bg_color = index.even? ? 'green' : 'blue' %>
            <div class="bg-<%= bg_color %>-50 rounded-lg p-4 border-2 border-<%= bg_color %>-200">
              <div class="flex items-start justify-between mb-3">
                <h4 class="font-bold text-gray-900"><%= location[:name] %></h4>
                <button type="button" class="text-red-hero hover:text-red-dark">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
              
              <div class="grid grid-cols-1 gap-3">
                <div>
                  <%= label_tag "location_#{index}_name", "Nom du lieu", class: "block text-xs font-medium text-gray-700 mb-1" %>
                  <%= text_field_tag "location_#{index}_name", location[:name], class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" %>
                </div>
                
                <div>
                  <%= label_tag "location_#{index}_address", "Adresse", class: "block text-xs font-medium text-gray-700 mb-1" %>
                  <%= text_field_tag "location_#{index}_address", location[:address], class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" %>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <%= label_tag "location_#{index}_postal_code", "Code postal", class: "block text-xs font-medium text-gray-700 mb-1" %>
                    <%= text_field_tag "location_#{index}_postal_code", location[:postal_code], class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" %>
                  </div>
                  <div>
                    <%= label_tag "location_#{index}_city", "Ville", class: "block text-xs font-medium text-gray-700 mb-1" %>
                    <%= text_field_tag "location_#{index}_city", location[:city], class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" %>
                  </div>
                </div>
                
                <div>
                  <%= label_tag "location_#{index}_notes", "Notes (optionnel)", class: "block text-xs font-medium text-gray-700 mb-1" %>
                  <%= text_area_tag "location_#{index}_notes", location[:notes], rows: 2, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm", placeholder: "Instructions d'accès, disponibilité du garage, etc." %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Add New Location Button -->
        <button type="button" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-green-500 hover:text-green-600 font-medium inline-flex items-center justify-center transition">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Ajouter un nouveau lieu de service
        </button>

        <hr class="my-8 border-gray-200">

        <!-- Reminder Toggle -->
        <h3 class="text-lg font-bold text-gray-900">Préférences de notification</h3>
        <p class="text-sm text-gray-600 mb-4">Gérez vos préférences de rappels automatiques</p>

        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-start space-x-3">
              <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="font-bold text-gray-900">Rappels automatiques</h4>
                <p class="text-sm text-gray-600 mt-1">Recevoir des notifications email/SMS pour les rendez-vous à venir</p>
              </div>
            </div>
            <div class="flex items-center">
              <label class="relative inline-flex items-center cursor-pointer">
                <%= f.check_box :reminders_enabled, checked: @profile&.reminders_enabled, class: "sr-only peer" %>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
              </label>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-start space-x-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="font-bold text-gray-900">Rappels d'entretien</h4>
                <p class="text-sm text-gray-600 mt-1">Recevoir des emails de rappel pour les entretiens et contrôles techniques de vos véhicules</p>
              </div>
            </div>
            <div class="flex items-center">
              <label class="relative inline-flex items-center cursor-pointer">
                <%= f.check_box :maintenance_reminders_enabled, checked: current_user&.maintenance_reminders_enabled?, class: "sr-only peer" %>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
              </label>
            </div>
          </div>
        </div>

        <hr class="my-8 border-gray-200">

        <h3 class="text-lg font-bold text-gray-900">Modifier le mot de passe</h3>
        <p class="text-sm text-gray-600 mb-4">Laissez vide si vous ne souhaitez pas changer votre mot de passe</p>

        <div>
          <%= f.label :password, "Nouveau mot de passe", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.password_field :password, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent", autocomplete: "new-password" %>
          <p class="text-sm text-gray-500 mt-1">Minimum 6 caractères</p>
        </div>

        <div>
          <%= f.label :password_confirmation, "Confirmation du mot de passe", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.password_field :password_confirmation, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-hero focus:border-transparent", autocomplete: "new-password" %>
        </div>

        <div class="flex space-x-4 pt-4">
          <button type="submit" class="w-80 bg-red-hero hover:bg-red-dark text-white px-8 py-3 rounded-lg font-bold cursor-pointer inline-flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Enregistrer les modifications
          </button>
          <%= link_to client_profile_path, class: "w-56 bg-gray-200 hover:bg-gray-300 text-gray-700 px-8 py-3 rounded-lg font-bold text-center inline-flex items-center justify-center" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Annuler
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
