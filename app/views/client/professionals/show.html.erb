<div class="bg-soft min-h-screen">
  <div class="container mx-auto px-6 py-8">
    
    <!-- Back Button -->
    <div class="mb-6">
      <%= link_to client_professionals_path, class: "text-blue-hero font-medium hover:underline inline-flex items-center" do %>
        ‚Üê Retour √† la recherche
      <% end %>
    </div>

    <!-- Professional Header -->
    <div class="bg-white rounded-super p-6 md:p-8 shadow-sm mb-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
        
        <!-- Left: Profile Info -->
        <div class="md:col-span-2">
          <div class="flex flex-col sm:flex-row sm:items-start gap-4 sm:gap-6 mb-6">
            <div class="w-20 h-20 sm:w-24 sm:h-24 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden bg-red-hero">
              <%= user_avatar_content(@professional, 
                    image_class: "w-full h-full object-cover", 
                    initials_class: "text-white text-3xl sm:text-4xl font-bold") %>
            </div>
            <div class="flex-1">
              <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2">
                <%= @professional.company_name.presence || @professional.get_full_name %>
              </h1>
              
              <!-- Rating - Hidden for now -->
              <div class="flex items-center space-x-3 mb-4" style="display: none;">
                <div class="flex text-yellow-hero text-2xl">
                  ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
                </div>
                <span class="text-lg font-bold text-gray-900">4.9</span>
                <span class="text-gray-600">(127 avis)</span>
              </div>

              <!-- Key Info -->
              <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                <% if @professional.location.present? %>
                  <span class="flex items-center">
                    üìç <%= @professional.location %>
                    <% if @professional.intervention_zone.present? %>
                      <% 
                        # Try to extract radius from intervention_zone
                        radius_match = @professional.intervention_zone.match(/(\d+)\s*km/i)
                        radius = radius_match ? radius_match[1] : nil
                      %>
                      <% if radius.present? %>
                        ‚Ä¢ Rayon <%= radius %> km
                      <% end %>
                    <% end %>
                  </span>
                <% end %>
                <% if @professional.phone_number.present? %>
                  <span class="flex items-center">
                    üìû <%= @professional.phone_number %>
                  </span>
                <% end %>
                <% if @professional.siret.present? %>
                  <span class="flex items-center">
                    üè¢ SIRET: <%= @professional.siret %>
                  </span>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Description -->
          <% if @professional.professional_presentation.present? %>
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-3">√Ä propos</h2>
              <p class="text-gray-600 leading-relaxed">
                <%= simple_format(@professional.professional_presentation) %>
              </p>
            </div>
          <% end %>

          <!-- Specialties -->
          <% if @professional.specialties.any? %>
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-3">Sp√©cialit√©s</h2>
              <div class="flex flex-wrap gap-3">
                <% @professional.specialties.order(:name).each do |specialty| %>
                  <div class="flex items-center space-x-2 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2">
                    <span class="text-xl"><%= specialty.icon %></span>
                    <span class="font-medium text-gray-900"><%= specialty.name %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Certifications - Hidden -->
          <div class="mb-6" style="display: none;">
            <h3 class="text-xl font-bold text-gray-900 mb-3">Certifications & Assurances</h3>
            <div class="flex flex-wrap gap-3">
              <span class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                ‚úì Dipl√¥me v√©rifi√©
              </span>
              <span class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                ‚úì Assurance professionnelle
              </span>
              <span class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                ‚úì SIREN v√©rifi√©
              </span>
            </div>
          </div>
        </div>

        <!-- Right: Quick Actions -->
        <div class="space-y-4">
          <% 
            # Calculate minimum price
            min_price = nil
            price_type = nil
            @professional_services.each do |ps|
              if ps.pricing_type == "hourly_rate" && ps.hourly_rate_price.present?
                if min_price.nil? || ps.hourly_rate_price < min_price
                  min_price = ps.hourly_rate_price
                  price_type = "hourly"
                end
              elsif ps.pricing_type == "flat_rate" && ps.flat_rate_price.present?
                if min_price.nil? || ps.flat_rate_price < min_price
                  min_price = ps.flat_rate_price
                  price_type = "flat"
                end
              end
            end
          %>
          
          <% if min_price.present? %>
            <div class="bg-red-50 border-2 border-red-hero rounded-super p-6 text-center">
              <p class="text-sm text-gray-600 mb-2">√Ä partir de</p>
              <p class="text-4xl font-bold text-red-hero mb-1">‚Ç¨<%= sprintf('%.0f', min_price) %></p>
              <p class="text-sm text-gray-600 mb-4"><%= price_type == "hourly" ? "par heure" : "(forfait)" %></p>
              <%= link_to new_client_booking_path(professional_id: @professional.id), class: "bg-red-hero hover:bg-red-dark text-white px-6 py-3 rounded-lg font-bold text-base md:text-lg w-full block mb-3 mx-auto inline-flex items-center justify-center" do %>
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                R√©server maintenant
              <% end %>
              <% 
                # Check for travel fees
                has_travel_fees = @professional_services.any? { |ps| ps.travel_flat_rate.present? || ps.travel_per_km_rate.present? }
              %>
              <% if has_travel_fees %>
                <p class="text-xs text-gray-500">+ Frais de d√©placement selon zone</p>
              <% end %>
            </div>
          <% end %>

          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <h4 class="font-bold text-gray-900 mb-3">Disponibilit√©s</h4>
            <div class="space-y-2 text-sm">
              <% 
                day_names = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche']
                (0..6).each do |day_of_week|
                  day_availabilities = @availabilities_by_day[day_of_week] || []
              %>
                <div class="flex items-start justify-between">
                  <span class="text-gray-600"><%= day_names[day_of_week] %></span>
                  <% if day_availabilities.any? %>
                    <div class="flex flex-col items-end gap-0.5">
                      <% day_availabilities.each do |availability| %>
                        <span class="font-medium text-gray-900"><%= availability.formatted_time_range %></span>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-red-600">Ferm√©</span>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>

          <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-sm text-gray-700 mb-2">
              üïê <span class="font-medium">Prochaine dispo:</span>
            </p>
            <p class="text-lg font-bold text-blue-hero">
              Demain 14:00
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Services Offered -->
      <% if @professional_services.any? %>
      <div class="bg-white rounded-super p-6 md:p-8 shadow-sm mb-8">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Services propos√©s</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <% @professional_services.each do |professional_service| %>
            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-start space-x-3 flex-1">
                  <div class="w-12 h-12 bg-red-hero rounded-lg flex items-center justify-center flex-shrink-0">
                    <% 
                      # Get icon from first service category
                      category = professional_service.services.first&.category
                      icon = case category
                             when 'mecanique'
                               'üîß'
                             when 'carrosserie'
                               'üî®'
                             when 'lavage'
                               '‚ú®'
                             else
                               'üìã'
                             end
                    %>
                    <span class="text-white text-xl"><%= icon %></span>
                  </div>
                  <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-900"><%= professional_service.name %></h3>
                    <% if professional_service.services.any? %>
                      <p class="text-sm text-gray-600 mt-1">
                        <%= professional_service.services.map(&:name).join(", ") %>
                      </p>
                    <% end %>
                  </div>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mt-4 pt-4 border-t border-gray-100">
                <% if professional_service.duration_minutes.present? %>
                  <span class="text-gray-600">
                    Dur√©e: <%= professional_service.duration_minutes %> min
                  </span>
                <% else %>
                  <span></span>
                <% end %>
                <div class="text-left sm:text-right">
                  <% if professional_service.display_price.present? %>
                    <span class="text-2xl font-bold text-red-hero">
                      <%= professional_service.display_price %>
                    </span>
                    <% if professional_service.pricing_type == "hourly_rate" %>
                      <p class="text-xs text-gray-500">par heure</p>
                    <% elsif professional_service.pricing_type == "flat_rate" %>
                      <p class="text-xs text-gray-500">forfait</p>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">Prix sur devis</span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Reviews Section - Hidden -->
    <div class="bg-white rounded-super p-8 shadow-sm mb-8" style="display: none;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-gray-900">Avis clients</h2>
        <div class="flex items-center space-x-2">
          <div class="flex text-yellow-hero text-2xl">
            ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
          </div>
          <span class="text-2xl font-bold text-gray-900">4.9</span>
          <span class="text-gray-600">/5</span>
        </div>
      </div>

      <!-- Rating Breakdown -->
      <div class="grid md:grid-cols-5 gap-4 mb-8 pb-8 border-b border-gray-200">
        <div class="text-center">
          <p class="text-sm text-gray-600 mb-2">Ponctualit√©</p>
          <p class="text-2xl font-bold text-gray-900">4.9</p>
          <div class="flex justify-center text-yellow-hero text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-600 mb-2">Qualit√©</p>
          <p class="text-2xl font-bold text-gray-900">5.0</p>
          <div class="flex justify-center text-yellow-hero text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-600 mb-2">Propret√©</p>
          <p class="text-2xl font-bold text-gray-900">4.8</p>
          <div class="flex justify-center text-yellow-hero text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-600 mb-2">Relationnel</p>
          <p class="text-2xl font-bold text-gray-900">5.0</p>
          <div class="flex justify-center text-yellow-hero text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-600 mb-2">Rapport qualit√©/prix</p>
          <p class="text-2xl font-bold text-gray-900">4.9</p>
          <div class="flex justify-center text-yellow-hero text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
      </div>

      <!-- Individual Reviews -->
      <div class="space-y-6">
        <!-- Review 1 -->
        <div class="border-b border-gray-100 pb-6">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-start space-x-3">
              <div class="w-12 h-12 bg-blue-hero rounded-full flex items-center justify-center">
                <span class="text-white font-bold">ML</span>
              </div>
              <div>
                <p class="font-bold text-gray-900">Marc L.</p>
                <p class="text-sm text-gray-600">Il y a 2 jours</p>
              </div>
            </div>
            <div class="flex text-yellow-hero">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
          </div>
          <p class="text-gray-700 leading-relaxed">
            Excellent service ! Jean est arriv√© √† l'heure, tr√®s professionnel et a pris le temps d'expliquer toutes les interventions. La r√©vision a √©t√© faite rapidement et bien. Je recommande vivement !
          </p>
          <p class="text-sm text-gray-500 mt-2">Service: R√©vision annuelle</p>
        </div>

        <!-- Review 2 -->
        <div class="border-b border-gray-100 pb-6">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-start space-x-3">
              <div class="w-12 h-12 bg-red-hero rounded-full flex items-center justify-center">
                <span class="text-white font-bold">SD</span>
              </div>
              <div>
                <p class="font-bold text-gray-900">Sophie D.</p>
                <p class="text-sm text-gray-600">Il y a 1 semaine</p>
              </div>
            </div>
            <div class="flex text-yellow-hero">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
          </div>
          <p class="text-gray-700 leading-relaxed">
            Parfait ! Jean a diagnostiqu√© le probl√®me rapidement et l'a r√©par√© sur place. Tr√®s bon rapport qualit√©/prix. Le fait qu'il se d√©place √† domicile est vraiment pratique.
          </p>
          <p class="text-sm text-gray-500 mt-2">Service: Diagnostic panne</p>
        </div>

        <!-- Review 3 -->
        <div class="border-b border-gray-100 pb-6">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-start space-x-3">
              <div class="w-12 h-12 bg-yellow-hero rounded-full flex items-center justify-center">
                <span class="text-white font-bold">PC</span>
              </div>
              <div>
                <p class="font-bold text-gray-900">Pierre C.</p>
                <p class="text-sm text-gray-600">Il y a 2 semaines</p>
              </div>
            </div>
            <div class="flex text-yellow-hero">‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ</div>
          </div>
          <p class="text-gray-700 leading-relaxed">
            Tr√®s satisfait du changement de pneus. Jean est venu avec tout le mat√©riel n√©cessaire. Travail soign√© et rapide. Juste un petit retard de 15 minutes mais il m'a pr√©venu.
          </p>
          <p class="text-sm text-gray-500 mt-2">Service: Changement pneus</p>
        </div>

        <!-- Review 4 -->
        <div class="pb-6">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-start space-x-3">
              <div class="w-12 h-12 bg-blue-hero rounded-full flex items-center justify-center">
                <span class="text-white font-bold">AM</span>
              </div>
              <div>
                <p class="font-bold text-gray-900">Anne M.</p>
                <p class="text-sm text-gray-600">Il y a 3 semaines</p>
              </div>
            </div>
            <div class="flex text-yellow-hero">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
          </div>
          <p class="text-gray-700 leading-relaxed">
            Je recommande √† 100% ! Jean a chang√© mes freins et a fait un travail impeccable. Prix honn√™te et transparent. Il a m√™me nettoy√© apr√®s son intervention. Top !
          </p>
          <p class="text-sm text-gray-500 mt-2">Service: Freinage complet</p>
        </div>
      </div>

      <div class="text-center mt-6">
        <button class="text-blue-hero font-medium hover:underline">
          Voir tous les avis (127) ‚Üí
        </button>
      </div>
    </div>

    <!-- Zone d'intervention -->
    <div class="bg-white rounded-super p-6 md:p-8 shadow-sm">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Zone d'intervention</h2>
      <% 
        # Extract radius from intervention_zone
        radius = nil
        if @professional.intervention_zone.present?
          radius_match = @professional.intervention_zone.match(/(\d+)\s*km/i)
          radius = radius_match ? radius_match[1] : nil
        end
        
        # Check for travel fees
        has_travel_fees = @professional_services.any? { |ps| ps.travel_flat_rate.present? || ps.travel_per_km_rate.present? }
        travel_fees = []
        @professional_services.each do |ps|
          if ps.travel_flat_rate.present?
            travel_fees << { type: "flat", amount: ps.travel_flat_rate }
          elsif ps.travel_per_km_rate.present?
            travel_fees << { type: "per_km", amount: ps.travel_per_km_rate }
          end
        end
        travel_fees.uniq!
      %>
      
      <% if has_travel_fees %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
          <div>
            <p class="text-gray-600 mb-4">
              <% if @professional.location.present? && radius.present? %>
                Je me d√©place dans un rayon de <span class="font-bold text-red-hero"><%= radius %> km</span> autour de <%= @professional.location %>
              <% elsif @professional.location.present? %>
                Je me d√©place autour de <%= @professional.location %>
              <% elsif @professional.intervention_zone.present? %>
                <%= @professional.intervention_zone %>
              <% end %>
            </p>
            <% if @professional.location.present? %>
              <div 
                data-controller="map" 
                data-map-location-value="<%= @professional.location %>"
                data-map-radius-value="<%= radius || 0 %>"
                class="rounded-lg h-64 w-full"
                style="z-index: 0;"
              >
                <div data-map-target="container" class="w-full h-full rounded-lg"></div>
              </div>
            <% else %>
              <div class="bg-gray-100 rounded-lg h-64 flex items-center justify-center">
                <p class="text-gray-400">Localisation non renseign√©e</p>
              </div>
            <% end %>
          </div>
          <div>
            <div class="p-4 bg-blue-50 rounded-lg">
              <h4 class="font-bold text-gray-900 mb-2">Frais de d√©placement</h4>
              <ul class="text-sm text-gray-700 space-y-1">
                <% travel_fees.each do |fee| %>
                  <li>
                    ‚Ä¢ 
                    <% if fee[:type] == "flat" %>
                      Forfait: ‚Ç¨<%= sprintf('%.2f', fee[:amount]) %>
                    <% else %>
                      Par km: ‚Ç¨<%= sprintf('%.2f', fee[:amount]) %>/km
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% else %>
        <div>
          <p class="text-gray-600 mb-4">
            <% if @professional.location.present? && radius.present? %>
              Je me d√©place dans un rayon de <span class="font-bold text-red-hero"><%= radius %> km</span> autour de <%= @professional.location %>
            <% elsif @professional.location.present? %>
              Je me d√©place autour de <%= @professional.location %>
            <% elsif @professional.intervention_zone.present? %>
              <%= @professional.intervention_zone %>
            <% end %>
          </p>
          <% if @professional.location.present? %>
            <div 
              data-controller="map" 
              data-map-location-value="<%= @professional.location %>"
              data-map-radius-value="<%= radius || 0 %>"
              class="rounded-lg h-64 w-full"
              style="z-index: 0;"
            >
              <div data-map-target="container" class="w-full h-full rounded-lg"></div>
            </div>
          <% else %>
            <div class="bg-gray-100 rounded-lg h-64 flex items-center justify-center">
              <p class="text-gray-400">Localisation non renseign√©e</p>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

  </div>
</div>
