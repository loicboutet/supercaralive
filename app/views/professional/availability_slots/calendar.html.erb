<% 
  # Calculate calendar grid
  first_day = @start_date
  first_day_of_week = first_day.wday == 0 ? 6 : first_day.wday - 1 # Convert to Monday=0 format
  last_day = @end_date
  days_in_month = last_day.day
  
  # Calculate previous month days to show
  prev_month_end = first_day - 1.day
  prev_month_days = []
  (first_day_of_week - 1).downto(0) do |i|
    prev_month_days << prev_month_end - i.days
  end
  
  # Calculate next month days to show
  last_day_of_week = last_day.wday == 0 ? 6 : last_day.wday - 1
  next_month_days = []
  (1..(6 - last_day_of_week)).each do |i|
    next_month_days << last_day + i.days
  end
  
  # Month names in French
  month_names = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 
                 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre']
  day_names = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche']
%>

<div class="bg-soft min-h-screen" data-controller="availability-calendar" data-availability-calendar-current-month-value="<%= @month %>" data-availability-calendar-current-year-value="<%= @year %>" data-availability-calendar-calendar-path-value="<%= calendar_professional_availability_slots_path %>">
  <div class="container mx-auto px-6 py-8">
    
    <!-- Header -->
    <div class="mb-6 md:mb-8">
      <div class="mb-4">
        <h1 class="text-2xl md:text-4xl font-bold text-gray-900 mb-2">Calendrier des Disponibilités</h1>
        <p class="text-sm md:text-base text-gray-600">Vue mensuelle de vos créneaux et réservations</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <button data-action="click->availability-calendar#openManualBookingModal" class="bg-red-hero hover:bg-red-dark text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold inline-flex items-center justify-center">
          <svg class="w-5 h-5 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span class="hidden sm:inline">Ajouter manuellement une réservation</span>
        </button>
      </div>
    </div>

    <!-- Calendar -->
    <div class="bg-white rounded-super p-6 shadow-sm">
      
      <!-- Month Navigation -->
      <div class="flex items-center justify-between mb-4 md:mb-6">
        <button data-action="click->availability-calendar#previousMonth" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 md:px-4 py-2 rounded-lg font-medium inline-flex items-center">
          <svg class="w-5 h-5 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="hidden md:inline">Précédent</span>
        </button>
        <h2 class="text-lg md:text-3xl font-bold text-gray-900" data-availability-calendar-target="monthDisplay"><%= month_names[@month - 1].capitalize %> <%= @year %></h2>
        <button data-action="click->availability-calendar#nextMonth" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 md:px-4 py-2 rounded-lg font-medium inline-flex items-center">
          <span class="hidden md:inline">Suivant</span>
          <svg class="w-5 h-5 md:ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>

      <!-- Calendar Grid -->
      <div class="border border-gray-200 rounded-lg overflow-hidden">
        <!-- Day Headers -->
        <div class="grid grid-cols-7 bg-gray-100 border-b border-gray-200">
          <% ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].each do |day| %>
            <div class="p-1 md:p-3 text-center text-xs md:text-sm font-bold text-gray-700 <%= day != 'Dim' ? 'border-r border-gray-200' : '' %>">
              <span class="hidden sm:inline"><%= day %></span>
              <span class="sm:hidden"><%= day[0] %></span>
            </div>
          <% end %>
        </div>

        <!-- Calendar Days -->
        <div class="grid grid-cols-7">
          <% # Previous month days %>
          <% prev_month_days.each do |date| %>
            <div class="p-1 md:p-3 bg-gray-50 border-r border-b border-gray-200 min-h-[60px] md:min-h-[120px]">
              <div class="text-xs md:text-sm text-gray-400 mb-1 md:mb-2"><%= date.day %></div>
            </div>
          <% end %>
          
          <% # Current month days %>
          <% (first_day..last_day).each do |date| %>
            <% 
              day_of_week = date.wday == 0 ? 6 : date.wday - 1
              is_today = date == @current_date
              is_weekend = date.wday == 0 || date.wday == 6
              
              # Get availabilities for this day of week
              day_availabilities = @availabilities_by_day[day_of_week] || []
              
              # Get bookings for this date
              day_bookings = @bookings_by_date[date] || []
              
              # Separate bookings by status
              pending_bookings = day_bookings.select { |b| b.status == 'pending' }
              accepted_bookings = day_bookings.select { |b| b.status == 'accepted' }
              
              # Build slots to display
              slots_to_display = []
              
              # Add availabilities (green)
              day_availabilities.each do |avail|
                slots_to_display << {
                  type: :availability,
                  time_range: format_time_range(avail.start_time, avail.end_time),
                  color: 'green'
                }
              end
              
              # Add pending bookings (yellow)
              pending_bookings.each do |booking|
                start_time = booking.scheduled_at.to_time
                end_time = start_time + (booking.professional_service.duration_minutes || 60).minutes
                slots_to_display << {
                  type: :booking_pending,
                  time_range: format_time_range(start_time, end_time),
                  color: 'yellow',
                  booking: booking,
                  manual: booking.manual?
                }
              end
              
              # Add accepted bookings (red)
              accepted_bookings.each do |booking|
                start_time = booking.scheduled_at.to_time
                end_time = start_time + (booking.professional_service.duration_minutes || 60).minutes
                slots_to_display << {
                  type: :booking_accepted,
                  time_range: format_time_range(start_time, end_time),
                  color: 'red',
                  booking: booking,
                  manual: booking.manual?
                }
              end
              
              # Limit displayed slots to 3, show "+X autres" if more
              display_slots = slots_to_display.first(3)
              remaining_count = slots_to_display.count - 3
            %>
            <div class="p-1 md:p-3 border-r border-b border-gray-200 min-h-[60px] md:min-h-[120px] hover:bg-gray-50 cursor-pointer <%= 'bg-yellow-50' if is_today %> <%= 'bg-blue-50' if is_weekend && !is_today %>" 
                 data-date="<%= date.strftime('%Y-%m-%d') %>"
                 data-action="click->availability-calendar#openDayModal"
                 role="button"
                 tabindex="0">
              <div class="flex items-center space-x-1 mb-1 md:mb-2">
                <div class="text-xs md:text-sm font-medium <%= is_today ? 'font-bold text-gray-900' : is_weekend ? 'text-blue-900' : 'text-gray-900' %>"><%= date.day %></div>
                <% if is_today %>
                  <div class="w-1.5 h-1.5 md:w-2 md:h-2 bg-yellow-hero rounded-full"></div>
                <% end %>
              </div>
              <div class="space-y-0.5 md:space-y-1">
                <% display_slots.each do |slot| %>
                  <% 
                    bg_color = case slot[:color]
                    when 'green' then 'bg-green-100 text-green-800'
                    when 'yellow' then 'bg-yellow-100 text-yellow-800'
                    when 'red' then 'bg-red-100 text-red-800'
                    end
                  %>
                  <div class="text-[10px] md:text-xs <%= bg_color %> px-1 md:px-2 py-0.5 md:py-1 rounded truncate inline-flex items-center gap-1">
                    <% if slot[:manual] %>
                      <svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" title="Création manuelle">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                      </svg>
                    <% end %>
                    <span class="truncate"><%= slot[:time_range] %></span>
                  </div>
                <% end %>
                <% if remaining_count > 0 %>
                  <div class="text-[9px] md:text-[10px] text-gray-600 font-medium mt-0.5">+<%= remaining_count %> autre<%= remaining_count > 1 ? 's' : '' %></div>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <% # Next month days %>
          <% next_month_days.each do |date| %>
            <div class="p-1 md:p-3 bg-gray-50 border-r border-b border-gray-200 min-h-[60px] md:min-h-[120px]">
              <div class="text-xs md:text-sm text-gray-400 mb-1 md:mb-2"><%= date.day %></div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Legend -->
      <div class="mt-4 md:mt-6 flex flex-wrap items-center justify-center gap-3 md:gap-6 text-xs md:text-sm">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 md:w-4 md:h-4 bg-yellow-50 border-2 border-yellow-hero rounded"></div>
          <span class="text-gray-700">Aujourd'hui</span>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 md:w-4 md:h-4 bg-green-100 rounded"></div>
          <span class="text-gray-700">Disponible</span>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 md:w-4 md:h-4 bg-yellow-100 rounded"></div>
          <span class="text-gray-700">Réservation en attente</span>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 md:w-4 md:h-4 bg-red-100 rounded"></div>
          <span class="text-gray-700">Réservation validée</span>
        </div>
      </div>

    </div>

    <!-- Month Summary -->
    <div class="grid sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mt-6 md:mt-8">
      <div class="bg-white rounded-lg p-4 md:p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs md:text-sm text-gray-600 mb-1">Créneaux disponibles</p>
            <p class="text-2xl md:text-3xl font-bold text-green-600"><%= @available_slots_count %></p>
          </div>
          <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 md:w-6 md:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4 md:p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs md:text-sm text-gray-600 mb-1">Réservations</p>
            <p class="text-2xl md:text-3xl font-bold text-red-600"><%= @total_bookings_count %></p>
          </div>
          <div class="w-10 h-10 md:w-12 md:h-12 bg-red-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 md:w-6 md:h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4 md:p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs md:text-sm text-gray-600 mb-1">Taux d'occupation</p>
            <p class="text-2xl md:text-3xl font-bold text-blue-hero"><%= @occupancy_rate %>%</p>
          </div>
          <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 md:w-6 md:h-6 text-blue-hero" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4 md:p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs md:text-sm text-gray-600 mb-1">Jours travaillés</p>
            <p class="text-2xl md:text-3xl font-bold text-gray-900"><%= @worked_days_count %></p>
          </div>
          <div class="w-10 h-10 md:w-12 md:h-12 bg-gray-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 md:w-6 md:h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Day Details Modal -->
    <div data-availability-calendar-target="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" data-action="click->availability-calendar#closeModal">
      <div class="bg-white rounded-super max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="bg-blue-hero p-6 rounded-t-super">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold text-white" data-availability-calendar-target="modalTitle"></h2>
            </div>
            <button data-action="click->availability-calendar#closeModal" class="text-white hover:bg-blue-dark p-2 rounded-lg transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6" data-availability-calendar-target="modalContent">
          <!-- Content will be loaded via AJAX -->
        </div>
      </div>
    </div>

    <!-- Manual Booking Modal -->
    <div id="manual_booking_modal" data-availability-calendar-target="manualBookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" data-action="click->availability-calendar#closeManualBookingModal">
      <div class="bg-white rounded-super max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="bg-red-hero p-6 rounded-t-super">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold text-white">Ajouter manuellement une réservation</h2>
            </div>
            <button data-action="click->availability-calendar#closeManualBookingModal" class="text-white hover:bg-red-dark p-2 rounded-lg transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6" data-availability-calendar-target="manualBookingContent">
          <!-- Content will be loaded via AJAX -->
        </div>
      </div>
    </div>

  </div>
</div>
